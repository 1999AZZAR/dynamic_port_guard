<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic Port Guard Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="container">
  <h1>Dynamic Port Guard Manager</h1>

  <!-- Flash Messages -->
  <div class="flash-messages section">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {# Messages are escaped in Python where needed, mark as safe here #}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message | safe }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Service Control & Status -->
  <div class="section service-status-grid">
      <div class="card">
          <div class="card-header">
              <h2>Core Service Control <small>({{ core_service_name }})</small></h2>
          </div>
          <div class="card-body service-actions">
              <form action="{{ url_for('service_action') }}" method="post" class="d-inline">
                <input type="hidden" name="action" value="start">
                <button type="submit" class="btn btn-success">Start</button>
              </form>
              <form action="{{ url_for('service_action') }}" method="post" class="d-inline">
                <input type="hidden" name="action" value="stop">
                <button type="submit" class="btn btn-danger">Stop</button>
              </form>
              <form action="{{ url_for('service_action') }}" method="post" class="d-inline">
                <input type="hidden" name="action" value="restart">
                <button type="submit" class="btn btn-warning">Restart</button>
              </form>
          </div>
      </div>
      <div class="card">
          <div class="card-header">
             <h2>Service Status</h2>
          </div>
           <div class="card-body">
              {# Service status output is escaped in Python, mark safe #}
              <div class="status-box">{{ service_status | safe }}</div>
           </div>
      </div>
  </div>


  <!-- Configuration -->
  <div class="section config-section">
      <div class="card">
          <div class="card-header">
            <h2>Configuration <small>({{ config_file_path }})</small></h2>
          </div>
          <div class="card-body">
            <form action="{{ url_for('update_config_route') }}" method="post">
              <div class="form-group">
                <label for="whitelist" class="form-label">Whitelist (Manual Edit: space separated `proto:port`)</label>
                <input type="text" class="form-control" id="whitelist" name="whitelist" value="{{ config.WHITELIST }}" aria-describedby="whitelistHelp">
                 <div id="whitelistHelp" class="form-text">Changes here require save. Use table actions for quicker Allow/Disallow.</div>
              </div>

              <div class="config-grid">
                  <div class="form-group">
                    <label for="check_interval" class="form-label">Check Interval (sec)</label>
                    <input type="number" class="form-control" id="check_interval" name="check_interval" value="{{ config.CHECK_INTERVAL }}" min="1" required>
                  </div>
                  <div class="form-group">
                    <label for="firewall_tool" class="form-label">Firewall Tool</label>
                    <select class="form-select" id="firewall_tool" name="firewall_tool">
                      <option value="iptables" {% if config.FIREWALL_TOOL == 'iptables' %}selected{% endif %}>iptables</option>
                      <option value="ufw" disabled>ufw (Not Implemented)</option>
                      <option value="nftables" disabled>nftables (Not Implemented)</option>
                    </select>
                  </div>
                  <div class="form-group">
                     <label for="iptables_chain" class="form-label">iptables Chain Name</label>
                    <input type="text" class="form-control" id="iptables_chain" name="iptables_chain" value="{{ config.IPTABLES_CHAIN }}" pattern="^[a-zA-Z0-9_-]{1,28}$" required title="Use A-Z, a-z, 0-9, _, - (max 28 chars)">
                  </div>
               </div>

               <div class="form-group">
                <label for="log_file" class="form-label">Log File Path</label>
                <input type="text" class="form-control" id="log_file" name="log_file" value="{{ config.LOG_FILE }}" required pattern="^/.*" title="Must be an absolute path (start with /)">
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Configuration & Restart Service</button>
              </div>
            </form>
          </div>
      </div>
  </div>

  <!-- Listening Ports -->
  <div class="section ports-section">
      <div class="card">
           <div class="card-header">
                <h2>Currently Listening Ports <small>(via `ss -tunlp`)</small></h2>
           </div>
           <div class="card-body">
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Protocol</th>
                        <th>Listen IP</th>
                        <th>Port</th>
                        <th>PID</th>
                        <th>Process/Application</th>
                        <th>Whitelist Status</th> {# Renamed Actions #}
                      </tr>
                    </thead>
                    <tbody>
                      {% if ports %}
                        {% for port in ports %}
                        {# Add class if whitelisted for potential styling #}
                        <tr class="{{ 'whitelisted-row' if port.is_whitelisted else '' }}">
                          <td>{{ port.proto }}</td>
                          <td>{{ port.ip }}</td>
                          <td>{{ port.port }}</td>
                          <td>{{ port.pid }}</td>
                          <td>{{ port.process_name | default('N/A', true) }}</td>
                          <td class="actions"> {# Keep class for styling buttons #}
                            {% if port.is_whitelisted %}
                              <form action="{{ url_for('modify_whitelist') }}" method="post" class="d-inline">
                                <input type="hidden" name="action" value="remove">
                                <input type="hidden" name="port_identifier" value="{{ port.port_identifier }}">
                                <button type="submit" class="btn btn-danger btn-sm" title="Remove {{ port.port_identifier }} from whitelist (Requires service restart)">Disallow</button>
                              </form>
                            {% else %}
                              <form action="{{ url_for('modify_whitelist') }}" method="post" class="d-inline">
                                <input type="hidden" name="action" value="add">
                                <input type="hidden" name="port_identifier" value="{{ port.port_identifier }}">
                                <button type="submit" class="btn btn-success btn-sm" title="Add {{ port.port_identifier }} to whitelist (Requires service restart)">Allow</button>
                              </form>
                            {% endif %}
                          </td>
                        </tr>
                        {% endfor %}
                      {% else %}
                      <tr>
                        <td colspan="6" class="text-center">No listening TCP/UDP ports detected or error retrieving them.</td> {# Updated colspan #}
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
           </div>
      </div>
  </div>


  <!-- Logs -->
  <div class="section logs-section">
       <div class="card">
           <div class="card-header d-flex justify-content-between align-items-center">
                <h2>Recent Logs <small>(from `{{ config.LOG_FILE }}`)</small></h2>
                <a href="{{ url_for('view_log') }}" class="btn btn-secondary btn-sm">View Full Log</a>
           </div>
           <div class="card-body">
                {# Logs are escaped in Python, mark safe #}
                <div class="log-box">
                  {{ logs | safe }}
                </div>
           </div>
       </div>
  </div>

</div> <!-- /container -->

<!-- Keep Bootstrap JS Bundle for alert dismissal and potential future components -->
<!-- Ensure it's loaded after your content -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
